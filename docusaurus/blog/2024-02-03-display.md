---
title: æç”»ã®æµã‚Œ
date: 2024-02-03
tags: [cpp]
---

æç”»ã®æµã‚Œã¨ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

<!-- truncate -->

## file.c ã‹ã‚‰ html æ§‹ç¯‰ã‚’åˆ†é›¢

```txt
file.c => 2800
html parse & 2d layout => 4300
```

ãã‚‰ã„ã«åˆ†ã‹ã‚ŒãŸã€‚
4300 ã®æ–¹ã‚’è¦‹ã‚‹ã€‚

## Buffer ã« è¡Œã‚’æ ¼ç´ã™ã‚‹

ç¬¬ä¸€æ®µéšã®å‡¦ç†ã€‚
URL ã‹ã‚‰ http request ã€content ã‚’ parse ã—ã¦ äºŒæ¬¡å…ƒãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã—ã¦æ ¼ç´ã™ã‚‹ã€‚

loadGeneralFile ãŒèµ·ç‚¹ã¨ãªã‚‹ã€‚

```c
Buffer *loadGeneralFile(char *path, ParsedURL *current, char *referer, int flag,
                        FormList *request);
```

## parse

loadHTMLBuffer ãŒèµ·ç‚¹ã¨ãªã‚‹ã€‚

```c
Buffer *loadHTMLBuffer(URLFile *f, Buffer *newBuf);
```

:::warning utf-8 ã®ãƒãƒ«ãƒãƒã‚¤ãƒˆå‡¦ç†å¿…è¦

```cpp title="file.c HTMLlineproc2body html parser ã®æ–‡å­—é€ã‚Š"
	    else if (*str != '<' && *str != '&') {
#ifdef USE_M17N
		int len = get_mclen(str);
#endif
		PPUSH(mode | effect | ex_efct(ex_effect), *(str++));
#ifdef USE_M17N
		if (--len) {
		    mode = (mode & ~PC_WCHAR1) | PC_WCHAR2;
		    while (len--) {
			PSIZE;
			PPUSH(mode | effect | ex_efct(ex_effect), *(str++));
		    }
		}
#endif

```

:::

## Line

```c
#define addnewline(a, b, c, d, e, f, g) _addnewline(a, b, c, e, f, g)
void addnewline(Buffer *buf, char *line, Lineprop *prop, Linecolor *color,
                int pos, int width, int nlines);
```

## Buffer ã‚’ æç”»ã™ã‚‹

ç¬¬äºŒæ®µéšã®å‡¦ç†ã€‚
Buffer ã«ãŸã‚ã“ã‚“ã  Line ã‚’ escape sequence ã§è£…é£¾ã—ã¦ TERM ã«å‡ºåŠ›ã™ã‚‹ã€‚

:::warning utf-8 ã®ãƒãƒ«ãƒãƒã‚¤ãƒˆå‡¦ç†å¿…è¦


:::

### display

```c
void addChar(char c, Lineprop mode);
void addMChar(char *p, Lineprop mode, size_t len);
```

### terms

1æ–‡å­— = 1byte = 1column ã§ãªããªã‚‹ãŸã‚ä»¥ä¸‹ã®é–¢æ•°ãŒå¤‰åŒ–ã™ã‚‹ã€‚
`USE_M17_N` ãƒã‚¯ãƒ­ãŒæœ‰åŠ¹ãªæ–¹ã§èµ·ãã‹ãˆã‚‹ã€‚
ã‚ªãƒªã‚¸ãƒŠãƒ«ã¯ã„ã‚ã„ã‚ãªæ–‡å­—ã‚³ãƒ¼ãƒ‰ã«å¯¾å¿œã—ã¦ã„ã‚‹ãŒã€
ã“ã¡ã‚‰ã®ã‚³ãƒ¼ãƒ‰ã¯ utf-8 æ±ºã‚ã†ã¡ã§å®Ÿè£…ã™ã‚‹ã€‚

- terms:addch & addmch
- terms:Screen
- terms:refresh
- terms:need_refresh

displayBuffer ãŒèµ·ç‚¹ã¨ãªã‚‹ã€‚

```cpp title="ã¡ã‚‡ã£ã¨æ‹¡å¼µã€‚ã†ã¾ãã„ãã‹ãªï¼Ÿ"
// // 1ã‚»ãƒ«ãŒè¤‡æ•°ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰æ§‹æˆã•ã‚Œã‚‹å ´åˆã«å¯¾å¿œã§ããªã„ã‘ã©ã¨ã‚Šã‚ãˆãšã€‚
// ç•°å­—ä½“ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚„åˆå­—ã€å¤‰ãªçµµæ–‡å­—ã¯å¾Œã§ã„ã„ã£ã™ã€‚
struct Utf8 {
  char8_t b0 = 0;
  char8_t b1 = 0;
  char8_t b2 = 0;
  char8_t b3 = 0;

  const char8_t *begin() const { return &b0; }

  const char8_t *end() const {
    if (b0 == 0) {
      return &b0;
    } else if (b1 == 0) {
      return &b1;
    } else if (b2 == 0) {
      return &b2;
    } else if (b3 == 0) {
      return &b3;
    } else {
      return (&b3) + 1;
    }
  }

  std::string_view view() const {
    return std::string_view((const char *)begin(),
                            std::distance(begin(), end()));
  }

  bool operator==(const Utf8 &rhs) const { return view() == rhs.view(); }
  bool operator!=(const Utf8 &rhs) const { return !(*this == rhs); }
};

struct Screen {
  char *lineimage; // En
  char **lineimage; // USE_M17_N
  Utf8 *lineimage; // ğŸ‘ˆ æ”¹é€ 
  l_prop *lineprop;
  short isdirty;
  short eol;
};
```

## ã„ã¡ãŠã† utf-8 ãŒè²«é€šã—ãŸ

ã¾ã ã‚«ãƒ¼ã‚½ãƒ«ã‚’å‹•ã‹ã™ã¨æç”»ãŒãšã‚ŒãŸã‚Šã™ã‚‹ã‘ã©ã€
ä»¥ä¸‹ã¯åŒã˜å‡¦ç†ã§è¡¨ç¤ºã§ããŸã€‚

- google search ã® ISO-8859-1 ã« unicode escape ã•ã‚Œã‚‹ã‚‚ã®
- content-type: utf-8

COLPOS ãªã©ã€ã‚«ãƒ©ãƒ ä½ç½®ã®è¨ˆç®—ã« utf-8 ã‚’ä½¿ã†ã“ã¨ãŒä¸å¾¹åº•ã«ãªã£ã¦ã„ã‚‹ã®ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ã‚ã‚Šã€‚
