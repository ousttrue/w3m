---
title: 描画の流れ
date: 2024-02-03
tags: [cpp]
---

描画の流れとデータ構造

<!-- truncate -->

## file.c から html 構築を分離

```txt
file.c => 2800
html parse & 2d layout => 4300
```

くらいに分かれた。
4300 の方を見る。

## Buffer に 行を格納する

第一段階の処理。
URL から http request 、content を parse して 二次元レイアウトして格納する。

loadGeneralFile が起点となる。

```c
Buffer *loadGeneralFile(char *path, ParsedURL *current, char *referer, int flag,
                        FormList *request);
```

## parse

loadHTMLBuffer が起点となる。

```c
Buffer *loadHTMLBuffer(URLFile *f, Buffer *newBuf);
```

:::warning utf-8 のマルチバイト処理必要

```cpp title="file.c HTMLlineproc2body html parser の文字送り"
	    else if (*str != '<' && *str != '&') {
#ifdef USE_M17N
		int len = get_mclen(str);
#endif
		PPUSH(mode | effect | ex_efct(ex_effect), *(str++));
#ifdef USE_M17N
		if (--len) {
		    mode = (mode & ~PC_WCHAR1) | PC_WCHAR2;
		    while (len--) {
			PSIZE;
			PPUSH(mode | effect | ex_efct(ex_effect), *(str++));
		    }
		}
#endif

```

:::

## Line

```c
#define addnewline(a, b, c, d, e, f, g) _addnewline(a, b, c, e, f, g)
void addnewline(Buffer *buf, char *line, Lineprop *prop, Linecolor *color,
                int pos, int width, int nlines);
```

## Buffer を 描画する

第二段階の処理。
Buffer にためこんだ Line を escape sequence で装飾して TERM に出力する。

:::warning utf-8 のマルチバイト処理必要


:::

### display

```c
void addChar(char c, Lineprop mode);
void addMChar(char *p, Lineprop mode, size_t len);
```

### terms

1文字 = 1byte = 1column でなくなるため以下の関数が変化する。
`USE_M17_N` マクロが有効な方で起きかえる。
オリジナルはいろいろな文字コードに対応しているが、
こちらのコードは utf-8 決めうちで実装する。

- terms:addch & addmch
- terms:Screen
- terms:refresh
- terms:need_refresh

displayBuffer が起点となる。

```cpp title="ちょっと拡張。うまくいくかな？"
// // 1セルが複数コードポイントから構成される場合に対応できないけどとりあえず。
// 異字体セレクターや合字、変な絵文字は後でいいっす。
struct Utf8 {
  char8_t b0 = 0;
  char8_t b1 = 0;
  char8_t b2 = 0;
  char8_t b3 = 0;

  const char8_t *begin() const { return &b0; }

  const char8_t *end() const {
    if (b0 == 0) {
      return &b0;
    } else if (b1 == 0) {
      return &b1;
    } else if (b2 == 0) {
      return &b2;
    } else if (b3 == 0) {
      return &b3;
    } else {
      return (&b3) + 1;
    }
  }

  std::string_view view() const {
    return std::string_view((const char *)begin(),
                            std::distance(begin(), end()));
  }

  bool operator==(const Utf8 &rhs) const { return view() == rhs.view(); }
  bool operator!=(const Utf8 &rhs) const { return !(*this == rhs); }
};

struct Screen {
  char *lineimage; // En
  char **lineimage; // USE_M17_N
  Utf8 *lineimage; // 👈 改造
  l_prop *lineprop;
  short isdirty;
  short eol;
};
```

## いちおう utf-8 が貫通した

まだカーソルを動かすと描画がずれたりするけど、
以下は同じ処理で表示できた。

- google search の ISO-8859-1 に unicode escape されるもの
- content-type: utf-8

COLPOS など、カラム位置の計算に utf-8 を使うことが不徹底になっているのを修正する必要あり。
