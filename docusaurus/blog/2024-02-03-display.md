---
title: 描画の流れ
date: 2024-02-03
tags: [cpp]
---

描画の流れとデータ構造

<!-- truncate -->

## file.c から html 構築を分離

```txt
file.c => 2800
html parse & 2d layout => 4300
```

くらいに分かれた。
4300 の方を見る。

## Buffer に 行を格納する

第一段階の処理。
URL から http request 、content を parse して 二次元レイアウトして格納する。

loadGeneralFile が起点となる。

```c
Buffer *loadGeneralFile(char *path, ParsedURL *current, char *referer, int flag,
                        FormList *request);
```

## parse

loadHTMLBuffer が起点となる。

```c
Buffer *loadHTMLBuffer(URLFile *f, Buffer *newBuf);
```

:::warning utf-8 のマルチバイト処理必要

```cpp title="file.c HTMLlineproc2body html parser の文字送り"
	    else if (*str != '<' && *str != '&') {
#ifdef USE_M17N
		int len = get_mclen(str);
#endif
		PPUSH(mode | effect | ex_efct(ex_effect), *(str++));
#ifdef USE_M17N
		if (--len) {
		    mode = (mode & ~PC_WCHAR1) | PC_WCHAR2;
		    while (len--) {
			PSIZE;
			PPUSH(mode | effect | ex_efct(ex_effect), *(str++));
		    }
		}
#endif

```

:::

## Line

行に文字列をつめこむ。
先頭から積算することで、カラム位置を計算する。

```c
#define addnewline(a, b, c, d, e, f, g) _addnewline(a, b, c, e, f, g)
void addnewline(Buffer *buf, char *line, Lineprop *prop, Linecolor *color,
                int pos, int width, int nlines);
```

## Buffer を 描画する

第二段階の処理。
Buffer にためこんだ Line を escape sequence で装飾して TERM に出力する。

### display

各行を出力する。

- redrawLine
- addChar, addMChar

全部終わったら、カーソル位置の Anchor をハイライトして再描画する。

- redrawLineRegion

こっちの関数で描画ずれが起こって難航。

### terms

1文字 = 1byte = 1column でなくなるため以下の関数が変化する。

- terms:Screen
- terms:addch & addmch
- terms:refresh
- terms:need_refresh

Screen は Line と違って、 column に対して index アクセスができる。

#### terms: addmch

Screen に Utf8バイト列を追加する(1code point)。

- 1code point 2カラム消費する場合がある。2カラムめに C_WCHAR2 フラグをセットすることでスキップする。忘れると半角スペースが出現したりして乱れる。
- 既存の C_WCHAR2 上に上書きになる場合がある。遡って削除する必要あり

#### terms: refresh

Screen を stdout(ttyf) に出力する。

```cpp
  for (line = 0; line <= LASTLINE; line++) {
    // 各行
    for (; col < COLS; col++) {
      // 各列
    }
  }
```

## いちおう utf-8 が貫通した

まだカーソルを動かすと描画がずれたりするけど、
以下は同じ処理で表示できた。

- google search の ISO-8859-1 に unicode escape されるもの
- content-type: utf-8

以下は表示できなかった。

- content-type: Shift_JIS

それはそう。
google の response がどういう基準で文字コードを変えているのかわからない。
Request-Header のどれかだとは思うのだが…
