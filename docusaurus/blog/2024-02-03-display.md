---
title: 描画の流れ
date: 2024-02-03
tags: [cpp]
---

描画の流れとデータ構造

<!-- truncate -->

## file.c から html 構築を分離

```txt
file.c => 2800
html parse & 2d layout => 4300
```

くらいに分かれた。
4300 の方を見る。

## Buffer に 行を格納する

第一段階の処理。
URL から http request 、content を parse して 二次元レイアウトして格納する。

:::warning utf-8 のマルチバイト処理必要
:::

loadGeneralFile が起点となる。

```c
Buffer *loadGeneralFile(char *path, ParsedURL *current, char *referer, int flag,
                        FormList *request);
```

## parse

loadHTMLBuffer が起点となる。

```c
Buffer *loadHTMLBuffer(URLFile *f, Buffer *newBuf);
```

## Line

```c
#define addnewline(a, b, c, d, e, f, g) _addnewline(a, b, c, e, f, g)
void addnewline(Buffer *buf, char *line, Lineprop *prop, Linecolor *color,
                int pos, int width, int nlines);
```

## Buffer を 描画する

第二段階の処理。
Buffer にためこんだ Line を escape sequence で装飾して TERM に出力する。

:::warning utf-8 のマルチバイト処理必要
:::

1文字 = 1byte = 1column でなくなるため以下の関数が変化する。
`USE_M17_N` マクロが有効な方で起きかえる。
オリジナルはいろいろな文字コードに対応しているが、
こちらのコードは utf-8 決めうちで実装する。

- terms:addch & addmch
- terms:Screen
- terms:refresh
- terms:need_refresh

displayBuffer が起点となる。

